# HakiMeet - AI面试官系统 整体架构设计

## 项目定位

基于多模态大模型的 AI 模拟面试系统，支持实时音视频交互、3D 数字人面试官、RAG 知识库驱动的智能提问，以及多维度面试评分。

## 系统架构总览（双模型 + WebRTC桥接）

```
┌──────────────────── Frontend (Vue 3 + Vite) ─────────────────────┐
│                                                                   │
│  ┌───────────┐  ┌───────────┐  ┌────────────┐  ┌──────────────┐ │
│  │  WebRTC   │  │  3D数字人  │  │  面试交互   │  │  评分/报告   │ │
│  │  音视频    │  │  Three.js  │  │  对话面板   │  │  可视化展示  │ │
│  │  采集/播放 │  │  口型同步  │  │  状态管理   │  │              │ │
│  └─────┬─────┘  └─────▲─────┘  └──────┬─────┘  └──────────────┘ │
│        │              │               │                           │
│        │   WebRTC     │  WebSocket    │  REST API                 │
└────────┼──────────────┼───────────────┼───────────────────────────┘
         │              │               │
         ▼              │               ▼
┌────────┼──────────────┼───────────────┼───────────────────────────┐
│        │    Backend (FastAPI + asyncio)│                           │
│        ▼              │               ▼                           │
│  ┌───────────┐  ┌─────┴─────┐  ┌───────────┐                    │
│  │  aiortc   │  │  WS管理器  │  │ REST路由  │                    │
│  │  媒体处理  │  │  流式推送  │  │ CRUD接口  │                    │
│  └──┬────┬──┘  └───────────┘  └───────────┘                    │
│     │    │                                                        │
│     │    └──── 视频帧 ────┐                                      │
│     │                      ▼                                      │
│     │  音频流    ┌──────────────────┐  ┌──────────────────┐      │
│     │            │  Gemini 2.0      │  │  RAG Pipeline    │      │
│     │            │  Flash API       │  │  ChromaDB向量库   │      │
│     │            │  视觉分析+评分    │  │  简历+题库+JD    │      │
│     │            └──────────────────┘  └──────────────────┘      │
│     ▼                                                             │
│  ┌──────────────────┐                                            │
│  │  豆包语音大模型    │  ← WebSocket双向流式                      │
│  │  实时语音对话      │  ← 支持打断                               │
│  │  (火山引擎API)    │  ← 后端注入RAG上下文/System Prompt        │
│  └────────┬─────────┘                                            │
│           │ 语音回复流                                            │
│           ▼                                                       │
│  ┌──────────┐  ┌──────────┐  ┌──────────────┐                   │
│  │ Viseme   │  │ 评分引擎  │  │  数据持久化   │                   │
│  │ 口型生成  │  │ 多维打分  │  │  SQLite/PG   │                   │
│  └──────────┘  └──────────┘  └──────────────┘                   │
└──────────────────────────────────────────────────────────────────┘
```

### 双模型分工

| 模型 | 职责 | 协议 |
|------|------|------|
| **豆包语音大模型** | 实时语音对话（语音输入→语音输出，支持打断） | WebSocket双向流式 |
| **Gemini 2.0 Flash** | 视频帧分析（微表情）、RAG评分、面试报告生成 | REST / WebSocket |

### 为什么后端要做桥接（而非前端直连豆包）

1. **安全**：API Key 留在后端，不暴露给前端
2. **RAG注入**：后端在转发音频前，向豆包注入 System Prompt + RAG检索的简历/题库上下文
3. **对话控制**：后端决定何时追问、换题、结束面试
4. **录音存档**：后端可保存音频用于回放和评分
5. **供应商解耦**：切换语音模型只改后端，前端不动

## 核心数据流（单轮对话）

```
1. [用户说话]
   浏览器 getUserMedia → WebRTC PeerConnection → aiortc 接收音频轨+视频轨

2. [音频路径: WebRTC → 后端 → 豆包]
   aiortc 提取音频帧 → VAD静音检测
   → 后端组装上下文(System Prompt + RAG检索结果)
   → WebSocket 转发音频流给豆包语音大模型
   → 豆包实时返回语音回复流

3. [视频路径(并行): WebRTC → 后端 → Gemini]
   aiortc 定时抽取视频帧(约1fps) → 缓存最近N帧
   → 发给 Gemini 2.0 Flash 做视觉分析(微表情/注意力)

4. [打断处理]
   用户在AI说话时开口 → aiortc检测到语音(VAD)
   → 后端发送打断信号给豆包 → 豆包停止输出
   → WebSocket通知前端停止播放 → 3D数字人闭嘴
   → 进入新一轮监听

5. [响应输出]
   豆包返回语音流 → 后端同时做:
     a. 转发语音给前端播放
     b. 语音转viseme时间轴(rhubarb-lip-sync)
     c. 语音转文字(用于存档和评分)
   → WebSocket 推送: {audio_chunks, viseme_timeline, text}

6. [前端渲染]
   播放AI语音 + 3D数字人口型同步 + 显示字幕

7. [评分(异步)]
   每轮对话结束 → Gemini 对回答内容打分 + 结合视频帧分析非语言表现
   评分维度: 内容质量 / 表达逻辑 / 专业深度 / 非语言表现
```

## 模块职责划分

| 模块 | 职责 | 关键技术 |
|------|------|---------|
| WebRTC通信层 | 音视频采集、传输、媒体处理 | aiortc, getUserMedia |
| 语音对话引擎 | 实时语音交互、打断处理 | 豆包语音大模型, WebSocket双向流式 |
| 视觉分析引擎 | 微表情识别、非语言评分 | Gemini 2.0 Flash, 视频帧分析 |
| RAG知识库 | 简历/题库/JD检索，上下文注入 | LangChain, ChromaDB |
| 口型生成 | 语音→viseme时间轴 | rhubarb-lip-sync |
| 3D渲染 | 数字人渲染、口型同步、表情动画 | Three.js, Ready Player Me |
| 评分系统 | 多维度打分、报告生成 | Gemini structured output |
| 数据层 | 用户/面试记录/简历存储 | SQLite(开发) / PostgreSQL(生产) |
